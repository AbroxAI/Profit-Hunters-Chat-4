<!DOCTYPE html>
<html lang="en">
(function runSanityCheck(){
  const report = { time: new Date().toISOString(), checks: {}, actions: [], notes: [] };

  // Helper
  function safeJSONParse(s){
    try { return { ok: true, val: JSON.parse(s) }; } catch(e){ return { ok: false, err: String(e) }; }
  }

  // 1) DOM elements
  const domIds = ["tg-comments-container","tg-comment-input","tg-send-btn","tg-pin-banner","tg-jump-indicator","tg-meta-line"];
  report.checks.dom = {};
  domIds.forEach(id=>{
    const el = document.getElementById(id);
    report.checks.dom[id] = !!el;
  });

  // 2) Script tags loaded
  try {
    report.checks.scripts = Array.from(document.querySelectorAll('script[src]')).map(s=>s.getAttribute('src'));
  } catch(e){ report.checks.scripts = { error: String(e) }; }

  // 3) Globals & API surface
  const globals = {
    identity: !!window.identity,
    realism: !!window.realism,
    TGRenderer: !!window.TGRenderer,
    BubbleRenderer: !!window.BubbleRenderer
  };
  report.checks.globals = globals;

  // Check functions
  report.checks.apis = {
    TGRenderer_appendMessage: !!(window.TGRenderer && typeof window.TGRenderer.appendMessage === "function"),
    TGRenderer_showTyping: !!(window.TGRenderer && typeof window.TGRenderer.showTyping === "function"),
    realism_postFromPoolV11: !!(window.realism && typeof window.realism.postFromPoolV11 === "function"),
    realism_simulateRandomCrowdV11: !!(window.realism && typeof window.realism.simulateRandomCrowdV11 === "function"),
    identity_getRandomPersona: !!(window.identity && typeof window.identity.getRandomPersona === "function")
  };

  // 4) Assets existence (async checks but we collect logs)
  report.checks.assets = {};
  const assets = ["assets/logo.jpg","assets/admin.jpg","assets/broadcast.jpg"];
  assets.forEach(u=>{
    const img = new Image();
    img.onload = ()=> { console.log("[asset] OK", u); };
    img.onerror = ()=> { console.warn("[asset] MISSING/404", u); };
    img.src = u + "?_t=" + Date.now();
    report.checks.assets[u] = "requested";
  });

  // 5) localStorage state sanity
  try {
    const rs = localStorage.getItem("abrox_realism_state_v1");
    const us = localStorage.getItem("abrox_used_avatars_v1");
    report.checks.localStorage = {
      abrox_realism_state_v1: rs ? (safeJSONParse(rs).ok ? "ok" : ("parse_error: "+safeJSONParse(rs).err)) : "missing",
      abrox_used_avatars_v1: us ? (safeJSONParse(us).ok ? "ok" : ("parse_error: "+safeJSONParse(us).err)) : "missing"
    };
  } catch(e){ report.checks.localStorage = { error: String(e) }; }

  // 6) Bubble count in DOM
  try { report.checks.domBubbleCount = document.querySelectorAll(".tg-bubble").length; } catch(e){ report.checks.domBubbleCount = "error: "+String(e); }

  // 7) MESSAGE_STATS size if realism exposed
  try {
    report.checks.messageStatsSize = window.realism && window.realism.MESSAGE_STATS ? (window.realism.MESSAGE_STATS.size || 0) : "no MESSAGE_STATS";
  } catch(e){ report.checks.messageStatsSize = "error: "+String(e); }

  // 8) SyntheticPool length (identity)
  try { report.checks.syntheticPoolLen = window.identity && Array.isArray(window.identity.SyntheticPool) ? window.identity.SyntheticPool.length : "no pool"; } catch(e){ report.checks.syntheticPoolLen = "error: "+String(e); }

  // 9) Quick small smoke post (safe): if TGRenderer exists, post one tiny test bubble
  report.actions.smokePost = "skipped";
  try {
    if(window.TGRenderer && typeof window.TGRenderer.appendMessage === "function"){
      const persona = (window.identity && window.identity.Admin) ? window.identity.Admin : { name:"DevTester", avatar:"assets/admin.jpg" };
      const id = window.TGRenderer.appendMessage(persona, "üß™ sanity-smoke test: " + new Date().toLocaleTimeString(), { timestamp: new Date(), type: "incoming" });
      report.actions.smokePost = id ? ("posted id: " + id) : "appendMessage returned falsy";
    } else if(window.BubbleRenderer && typeof window.BubbleRenderer.renderMessages === "function"){
      window.BubbleRenderer.renderMessages([{ id:"dbg_"+Date.now(), name:"DevTester", text:"üß™ sanity-smoke (fallback)", time:new Date().toLocaleTimeString(), isOwn:false }]);
      report.actions.smokePost = "posted via BubbleRenderer.renderMessages";
    } else {
      report.actions.smokePost = "no renderer available (TGRenderer/BubbleRenderer missing)";
    }
  } catch(e){ report.actions.smokePost = "error: "+String(e); }

  // 10) Auto-shim: if BubbleRenderer exists but TGRenderer missing, create shim
  if(window.BubbleRenderer && !window.TGRenderer){
    try{
      window.TGRenderer = {
        appendMessage: function(persona, text, opts){ 
          // map to BubbleRenderer.renderMessages
          try {
            const msg = { id: opts && opts.id ? opts.id : ("auto_"+Date.now()), name: persona && persona.name ? persona.name : "User", text: text, time: (opts && opts.timestamp) ? (new Date(opts.timestamp)).toLocaleTimeString() : new Date().toLocaleTimeString(), isOwn: (opts && opts.type==="outgoing") };
            window.BubbleRenderer.renderMessages([msg]);
            return msg.id;
          } catch(e){ console.warn("TGRenderer shim appendMessage failed", e); return null; }
        },
        showTyping: function(persona, duration){ 
          try {
            // show a simple typing bubble for persona for 'duration' ms then remove
            const el = document.createElement("div"); el.className="tg-bubble incoming typing"; el.innerHTML=`<img class="tg-bubble-avatar" src="${persona && persona.avatar?persona.avatar:'assets/admin.jpg'}" /><div class="tg-bubble-content"><div class="tg-reply-preview">${persona && persona.name?persona.name:'Someone'} is typing‚Ä¶</div></div>`;
            const c = document.getElementById("tg-comments-container"); if(c) c.appendChild(el), c.scrollTop = c.scrollHeight;
            setTimeout(()=>{ if(el && el.parentNode) el.parentNode.removeChild(el); }, duration||1500);
          } catch(e){ console.warn("TGRenderer shim showTyping failed", e); }
        }
      };
      report.actions.autoshim = "TGRenderer shim created from BubbleRenderer";
    } catch(e){ report.actions.autoshim = "shim failed: "+String(e); }
  } else {
    report.actions.autoshim = "not needed";
  }

  // 11) If realism missing but TGRenderer present, attempt to trigger a pool post if ensurePoolV11 exists
  if(window.realism && typeof window.realism.postFromPoolV11 === "function"){
    // do nothing now (avoid spamming). user can trigger manually.
    report.actions.realismReady = "ok";
  } else if(!window.realism){
    report.actions.realismReady = "window.realism missing";
  } else {
    report.actions.realismReady = "realism present but postFromPoolV11 not found";
  }

  // Print summary nicely
  console.groupCollapsed("Sanity Check Report (" + report.time + ")");
  console.table(report.checks.dom);
  console.log("scripts loaded:", report.checks.scripts);
  console.log("globals:", report.checks.globals);
  console.log("api surface checks:", report.checks.apis);
  console.log("localStorage check:", report.checks.localStorage);
  console.log("dom bubble count:", report.checks.domBubbleCount);
  console.log("MESSAGE_STATS size:", report.checks.messageStatsSize);
  console.log("SyntheticPool len:", report.checks.syntheticPoolLen);
  console.log("actions:", report.actions);
  if(report.actions.smokePost) console.log("smokePost:", report.actions.smokePost);
  console.groupEnd();

  // Also return the report object for easy copy/paste
  return report;
})();
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Abrox ‚Äì Profit Hunters Chat (Realism)</title>

  <!-- Main styles (must exist) -->
  <link rel="stylesheet" href="widget.css" />

  <style>
    html,body{height:100dvh;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;-webkit-font-smoothing:antialiased;}
    .hidden{display:none!important;}
  </style>

  <!--
    Runtime config (must be set BEFORE modules load).
    IMPORTANT: upload these assets to your repo EXACTLY (case-sensitive):
      - assets/logo.jpg        <-- site header logo (REQUIRED)
      - assets/admin.jpg       <-- admin avatar (REQUIRED)
      - assets/broadcast.jpg   <-- admin broadcast image (REQUIRED)
  -->
  <script>
    window.CONTACT_ADMIN_LINK = "https://t.me/ph_suppp";
    window.MEMBER_COUNT = 1284;
    window.ONLINE_COUNT = 128;

    // Large pool defaults. For DEBUG use smaller numbers (TOTAL_PERSONAS: 200, INITIAL_POOL: 200).
    window.REALISM_CONFIG = {
      TOTAL_PERSONAS: 5000,
      INITIAL_POOL: 1500,
      POOL_MIN: 1200,
      POOL_MAX: 5000,
      DEDUP_LIMIT: 200000,
      MIN_INTERVAL_MS: 20000,
      MAX_INTERVAL_MS: 60000,
      REACTION_TICK_MS: 30000,
      TREND_SPIKE_PROB: 0.02
    };

    window.JOINER_CONFIG = {
      minIntervalMs: 1000*60*60*6,
      maxIntervalMs: 1000*60*60*24,
      initialJoins: 3,
      welcomeMessage: "Welcome! Please use Contact Admin to verify."
    };

    // Optional: Provide hosted avatar URLs for higher realism.
    // window.UPLOADED_AVATARS = ["https://cdn.yoursite.com/ava1.jpg", ...];
  </script>
</head>
<body>
  <div id="tg-comments-app">

    <!-- Header -->
    <header class="tg-header" role="banner">
      <button id="tg-back" class="tg-back-btn" aria-label="Back"><i data-lucide="arrow-left"></i></button>

      <div class="tg-header-center">
        <!-- FIXED: logo should load from assets/logo.jpg (not admin avatar) -->
        <img src="assets/logo.jpg" alt="Profit Hunters Logo" class="tg-header-avatar" />
        <div class="tg-header-info">
          <div class="tg-title">üåê Profit Hunters Chat</div>
          <div class="tg-meta" id="tg-meta-line">1,284 members, 128 online</div>
        </div>
      </div>

      <button id="tg-options" class="tg-options-btn" aria-label="Options"><i data-lucide="more-vertical"></i></button>
    </header>

    <!-- Pinned message banner area (app will populate) -->
    <div id="tg-pin-banner" class="tg-pin-banner hidden" role="region" aria-live="polite"></div>

    <!-- Chat container (renderer appends bubbles here) -->
    <main id="tg-comments-container" class="tg-comments-container" role="feed" aria-live="off"></main>

    <!-- New messages jump pill -->
    <div id="tg-jump-indicator" class="hidden" aria-hidden="true">
      <i data-lucide="chevron-down"></i>
      <span id="tg-jump-text">New messages</span>
    </div>

    <!-- Floating input pill -->
    <div class="tg-input-wrapper" role="form" aria-label="Send a message">
      <div class="tg-input-bar glass">
        <button id="tg-emoji-btn" class="tg-icon-btn" aria-label="Emoji"><i data-lucide="smile"></i></button>
        <input type="text" id="tg-comment-input" class="tg-comment-input" placeholder="Message‚Ä¶" autocomplete="off" />
        <button id="tg-camera-btn" class="tg-icon-btn" aria-label="Camera"><i data-lucide="camera"></i></button>
        <button id="tg-send-btn" class="tg-send-btn hidden" aria-label="Send message"><i data-lucide="send"></i></button>
      </div>
    </div>

  </div>

  <!-- Icons (must be loaded BEFORE modules so they can render icons) -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Module scripts (order is critical) -->
  <script src="identity-personas.js"></script>
  <script src="bubble-renderer.js"></script>
  <script src="realism-engine-v11.js"></script>
  <script src="interactions.js"></script>
  <script src="app.js"></script>
  <script src="joiner-simulator.js"></script>

  <!-- Ensure icons are created/updated after modules render icon nodes -->
  <script>lucide.createIcons();</script>
</body>
</html>
